name: Deploy to EC2

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

jobs:
  deploy:
    runs-on: ubuntu-latest

    permissions:
      id-token: write
      contents: read

    steps:
      # ✅ 1. Checkout code
      - name: Checkout
        uses: actions/checkout@v4

      # ✅ 2. Configure AWS credentials using OIDC
      - name: Configure AWS Credentials (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          aws-region: ${{ secrets.AWS_REGION }}
          role-to-assume: arn:aws:iam::1731489XXXXX:role/EC2SSMRole

      # ✅ 3. Login to Amazon ECR
      - name: Login to ECR
        id: ecr_login
        uses: aws-actions/amazon-ecr-login@v2

      # ✅ 4. Ensure ECR repository exists
      - name: Create ECR repository if missing
        run: |
          aws ecr describe-repositories --repository-names basic-web-ec2 >/dev/null 2>&1 || \
          aws ecr create-repository --repository-name basic-web-ec2

      # ✅ 5. Build & push Docker image to ECR
      - name: Build & Push Docker Image
        env:
          REGISTRY: ${{ steps.ecr_login.outputs.registry }}
          REPO: basic-web-ec2
          IMAGE_TAG: ${{ github.sha }}
        run: |
          docker build -t $REGISTRY/$REPO:$IMAGE_TAG .
          docker push $REGISTRY/$REPO:$IMAGE_TAG
          echo "IMAGE_URI=$REGISTRY/$REPO:$IMAGE_TAG" >> $GITHUB_ENV

      # ✅ 6. Find EC2 instance by tag
      - name: Find EC2 instance ID
        id: find_instance
        run: |
          IID=$(aws ec2 describe-instances \
            --filters "Name=tag:Name,Values=basic-web-ec2" "Name=instance-state-name,Values=running" \
            --query "Reservations[0].Instances[0].InstanceId" --output text)

          if [ "$IID" = "None" ] || [ -z "$IID" ]; then
            echo "No running EC2 instance found with tag: basic-web-ec2"
            exit 1
          fi

          echo "INSTANCE_ID=$IID" >> $GITHUB_ENV
          echo "Found EC2 instance: $IID"

      # ✅ 7. DEPLOY: SSH into EC2 & restart Docker container
      - name: Deploy to EC2 over SSH
        uses: appleboy/ssh-action@v1.0.3
        with:
          host: ${{ secrets.EC2_PUBLIC_IP }}
          username: ubuntu
          key: ${{ secrets.EC2_SSH_KEY }}
          script: |
            echo "Logging into AWS ECR..."
            aws ecr get-login-password --region ${{ secrets.AWS_REGION }} \
              | docker login --username AWS --password-stdin ${{ steps.ecr_login.outputs.registry }}

            echo "Pulling latest image..."
            docker pull ${{ env.IMAGE_URI }}

            echo "Removing old container..."
            docker stop web || true
            docker rm web || true

            echo "Starting updated container..."
            docker run -d --name web -p 80:80 ${{ env.IMAGE_URI }}

            echo "Deployment completed successfully."
