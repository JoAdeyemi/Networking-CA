name: Deploy App to EC2 via ECR

on:
  push:
    branches: [ "main" ]
  workflow_dispatch: {}

permissions:
  id-token: write
  contents: read

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
    - name: Checkout repository
      uses: actions/checkout@v4

    # -------------------------------
    #  AWS OPENID CONNECT AUTH
    # -------------------------------
    - name: Configure AWS Credentials (OIDC)
      uses: aws-actions/configure-aws-credentials@v4
      with:
        aws-region: ${{ secrets.AWS_REGION }}
        role-to-assume: arn:aws:iam::173148968885:role/EC2SSMRole

    # -------------------------------
    #  LOGIN TO ECR
    # -------------------------------
    - name: Login to Amazon ECR
      uses: aws-actions/amazon-ecr-login@v2

    # -------------------------------
    #  CREATE REPO (IF NOT EXISTS)
    # -------------------------------
    - name: Ensure ECR Repo Exists
      run: |
        aws ecr describe-repositories --repository-names basic-web-ec2 >/dev/null 2>&1 || \
        aws ecr create-repository --repository-name basic-web-ec2

    # -------------------------------
    #  BUILD & PUSH DOCKER IMAGE
    # -------------------------------
    - name: Build and Push Docker Image
      env:
        REGISTRY: ${{ steps.login-ecr.outputs.registry }}
        REPO: basic-web-ec2
        IMAGE_TAG: ${{ github.sha }}
      run: |
        docker build -t $REGISTRY/$REPO:$IMAGE_TAG .
        docker push $REGISTRY/$REPO:$IMAGE_TAG
        echo "IMAGE_URI=$REGISTRY/$REPO:$IMAGE_TAG" >> $GITHUB_ENV

    # -------------------------------
    #  DEPLOY TO EC2 USING SSH
    # -------------------------------
    - name: Deploy to EC2 over SSH
      uses: appleboy/ssh-action@v1.0.3
      with:
        host: ${{ secrets.EC2_PUBLIC_IP }}
        username: ubuntu
        key: ${{ secrets.EC2_SSH_KEY }}
        script: |
          echo "Logging into ECR on EC2..."
          aws ecr get-login-password --region ${{ secrets.AWS_REGION }} | docker login --username AWS --password-stdin $REGISTRY

          echo "Pulling latest image..."
          docker pull $IMAGE_URI

          echo "Stopping & Removing old container..."
          docker stop web || true
          docker rm web || true

          echo "Starting new container..."
          docker run -d --name web -p 80:80 $IMAGE_URI

